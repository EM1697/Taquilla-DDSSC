@model List<TaquillaITH.Models.Movie>
@{
    ViewData["Title"] = "Venta de boletos";
    DateTime CurrentDate = (DateTime)ViewData["CurrentDate"];

    var precioNormal = (int)ViewData["precioNormal"] == 0 ? 50 : ViewData["precioNormal"];
    var precio3D = (int)ViewData["precio3D"] == 0 ? 50 : ViewData["precio3D"];
    var precioVIP = (int)ViewData["precioVIP"] == 0 ? 50 : ViewData["precioVIP"];
}
<div id="Step1">
    <div class="text-center container">
        <div class="row">
            <div class="col-12">
                <h1 class="display-4">Catálogo de Películas</h1>
            </div>
        </div>
        <div class="row mt-2 justify-content-md-center">
            <div class="col-6">
                <p>Al dia de:</p>
            </div>
        </div>
        <div class="row mt-2 justify-content-md-center">
            <div class="col-6">
                <input id="datePicker" type="date" class="form-control" placeholder="Fecha" aria-label="Fecha" aria-describedby="addon-wrapping">
            </div>
        </div>
        <div class="row">
            <hr />
            @if (Model.Any())
            {
                @foreach (var item in Model)
                {
                    <div class="col-5 mt-2 mb-2 ml-2 mr-2" style="border: solid black 2px;">
                        <h1> @item.Name </h1>
                        <img src="@item.photoUrl" width="350" height="600" />
                        <br />
                        @foreach (var schedule in item.horarios)
                        {
                            var horario = schedule;
                            <button type="button" value="@schedule" class="btn btn-primary mt-2 ml-2" onclick="ToggleSelect(@item.duracion, '@horario', '@item.pelicula','@item.sala')"
                                    data-toggle="button" aria-pressed="false" autocomplete="off" id="MovieId-@item.duracion">
                                @schedule
                            </button>

                        }
                        <br />
                        <div id="@item.duracion" class="mt-2 SelectTicket" style="display:none;">
                            <select id="mySelect-@item.duracion">
                                <option selected disabled>Seleccione un tipo de boleto</option>
                                <option value="@precioNormal"> Boleto Normal</option>
                                <option value="@precio3D"> Boleto 3D</option>
                                <option value="@precioVIP"> Boleto VIP</option>
                            </select>

                            <div class="form-group">
                                <label class="control-label">Cantidad</label>
                                <input class="form-control" type="number" max="10" min="1" id="ticketAmount-@item.duracion" />
                            </div>

                            <label>Sala: @item.sala</label>
                            <input id="sala-@item.duracion" value="@item.sala" style="display:none;"/>
                            <br />
                            <label>Duración: @item.duracion</label>
                            <input id="duracion-@item.duracion" value="@item.duracion" style="display:none;"/>
                            <br />
                            <label>Genero: @item.genero</label>
                            <input id="genero-@item.duracion" value="@item.genero" style="display:none;"/>
                            <br />
                            <input id="schedule-@item.duracion" value="@item.horarios" style="display:none;"/>
                            <input id="movie-@item.duracion" value="@item.pelicula" style="display:none;"/>

                            <button class="btn btn-outline-success" id="btnSelectButton" onclick="SelectShowTime(@item.duracion,@item.sala)"> Seleccionar función</button>
                        </div>
                    </div>
                    <hr />
                }
            }
        </div>
    </div>
</div>



<div id="Step2" style="display:none;">
    <partial name="_Step2">
</div>

<div id="Step3" style="display:none;">
    <partial name="_Step3">
</div>

<div id="Step4" style="display:none;">
    <partial name="_Step4">
    <partial name="_Step5">
</div>
<!--
<div id="Step5" style="display:none;">
    <partial name="_Step5">
</div>
-->


<script>
    var alaea = new Date(Date.parse('@CurrentDate'));
    var selectedTicketType = "";
    var selectedMovieId =  0;
    var TheatreRoom =  0;
    var ticketAmount = 0;
    var Judir = "";
    var puntosDisponibles = 0;
    var showDate = "";
    var selectedSchedule = "";
    var conconatenadoFecha = "";
    var selectedTicket = "";
    var selectedMovie = "";

    var products = [];
    var seatsList = [];
    var time = "";
    var movieName = "";
    var genre = "";
    var movie = "";
    var payment = 0;
    var pointsUsed = 0;
    var credit = 0;
    var ticketType;
    var usedCredit = true;
    var pointFlag = false;
    var cardHolder = "";
    var userMembershipId = 0;
    function ToggleSelect(id, schedule, pelicula)
    {
        $('#' + id).toggle();
        selectedMovieId = id;
        selectedSchedule = schedule;
        selectedMovie = pelicula;
    }

    $(document).ready(function () {
        var day = alaea.getDate();
        var month = alaea.getMonth() + 1;
        var year = alaea.getFullYear();
        if (month < 10) month = "0" + month;
        if (day < 10) day = "0" + day;
        var today = year + "-" + month + "-" + day;
        Judir = today;

        if (!alaea)
        {
            $("#datePicker").val(alaea);
        }
        else
        {
            $("#datePicker").val(today);
        }
    });

    $("#datePicker").change(function () {
        var date = new Date($("input").val());
        var day = date.getDate() + 1;
        (day.toString()).length == 1 ? daySpace="0" : day;
        var month = date.getMonth() +1;
        var year = date.getFullYear();
        var time = year + "-" + month + "-" + day + " " + "13:09:00";
        var TotalAmount = 0;

        if (!alaea)
        {
            $("#datePicker").val(alaea);
        }
        else
        {
            $("#datePicker").val(time);
        }

        $.ajax({
            url: "/TicketSale/Step1",
            type: 'GET',
            data: { 'date': time },
            success: function (data) {
                window.location.href = "/TicketSale/Step1?date=" + time;
            }, error: function (data) {
                window.location.href = "/TicketSale/Step1?date="+time;
            }
        });
    });
    

    $("#cashInput").change(function(){
        if($("#cashInput").val() < TotalAmount){
            $("#cashInput").css("border-color", "red");
            $("#cashInput").css("color", "red");
            $("#CashChange").css("color", "red");
            $("#CashChange").text("Valor insuficiente");
        }
        else{
            $("#cashInput").css("border-color", "black");
            $("#cashInput").css("color", "black");
            $("#CashChange").css("color", "black");
            $("#CashChange").text(($("#cashInput").val()).toString() - TotalAmount);
        }
    });

    function SelectShowTime(id, Num_sala)
    {
        movie = $("#movie-"+id).val();
        genre = $("#genero-"+id).val();
        TheatreRoom = Num_sala;
        ticketAmount = $("#ticketAmount-"+id).val();
        selectedTicket = $("#mySelect-" + id + " :selected").val();
        ticketType = $("#mySelect-" + id + " :selected").text();

        if ($("#mySelect-" + id + " :selected").val() != "Seleccione un tipo de boleto") {
            if ($("#mySelect-" + id + " :selected").val().length > 0 && $("#ticketAmount-"+id).val() != ""){
                TheatreRoom = Num_sala;
                ticketAmount = $("#ticketAmount-"+id).val();
                selectedTicket = $("#mySelect-" + id + " :selected").val();

                var date = $("#datePicker").val() + " " + selectedSchedule;
                $.ajax({
                    type: "GET",
                    url: "/api/Booth/GetShowSeats",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data:
                    {
                        "idSala": TheatreRoom,
                        "Horario": date
                    },
                    success: function (data) {
                        console.log(data);

                        data.forEach(function (element) {
                            var tr = document.createElement("div");

                            element.forEach(function (dato)
                            {
                                var btn = document.createElement("button");
                                btn.className = "btn btn-outline-dark m-2";
                                btn.onclick = (function ()
                                {
                                    if (!seatsList.includes(this.innerHTML) && seatsList.length < ticketAmount)
                                    {
                                        seatsList.push(dato.name);
                                            $(this).css("background", "pink");
                                        console.log(seatsList);

                                
                                    }
                                    else if (seatsList.includes(this.innerHTML)) {
                                        seatsList.splice(seatsList.indexOf(dato.name), 1);
                                        $(this).css("background", "white");
                                        console.log(seatsList);
                                    }

                                    if (seatsList.length == ticketAmount) {
                                        $("#To3rdStep").show();
                                    } else {
                                        $("#To3rdStep").hide();
                                    }
                                });

                                if (dato.occupied)
                                {
                                    btn.innerHTML = "X"
                                    btn.setAttribute("disabled", "true");
                                }
                                else
                                    btn.innerHTML = dato.name

                                tr.append(btn);
                            })

                            $("#ShowSeats").append(tr);
                        })

                        $("#Step1").toggle();
                        $("#Step2").toggle();
                        TotalAmount = ticketAmount * parseInt(selectedTicket);
                        $("#totalAmountPay").text(TotalAmount);
                        $("#totalAmountPayCash").text(TotalAmount);
                    },
                    error: function (data) {
                        alert(data.responseText);
                    }
                }); 
            }
            else{
                alert("Favor de seleccionar asientos");
            }
        }
        else {
            alert("Favor de seleccionar un tipo de boleto")
        }

    }

    $("#To3rdStep").click(function () {
        $("#Step2").toggle();
        $("#Step3").toggle();
    });

    $("#skipMembership").click(function () {
        $("#creditFund").text(TotalAmount.toString());
        $("#Step3").toggle();
        $("#Step4").toggle();
    });

    $("#To4rthStep").click(function () {
        points();
    });

    $("#FINISHED").click(function () {
         ItsOver();
    });

    $("#finalbtn").click(function () {
        location.href("/TicketSale/Step1");
    });

    function paymentMethod(){
        $("#creditBlock").toggle();
        $("#cashBlock").toggle();
        $("#cashbtn").toggle();
        $("#creditbtn").toggle();
        usedCredit = !usedCredit;
    };

    debugger;
    function member() {
        textInput($("#membershipNumber"));
        var id = $("#membershipNumber").val();
        $.ajax({
        url: "/api/Booth/GetMembership",
        type: 'GET',
        data: {'id':id},
            success: function (data) {
                $("#membership").hide();
                $("#points").show();
                $("#membershipId").text(data.id_Membresia);
                $("#membershipOwner").text(data.nombre);
                $("#membershipPoints").text(data.puntos);
                $("#membershipPercent").text(data.porcentaje);
                puntosDisponibles = data.puntos;
                cardHolder = $("#membershipOwner").text();
                userMembershipId = $("#membershipId").text();
                console.log("Success");
            }
        });
    }

    function points() {
        if($("#requiredPoints").val() <= TotalAmount)
        {
            textInput($("#requiredPoints"));
            var id = $("#membershipId").text();
            var puntosGenerados = (parseInt($("#membershipPercent").text()) / 100) * TotalAmount;
            $.ajax({
                url: "/api/Booth/PostMembershipPoints?id_Membresia=" + id + "&puntos="+ puntosGenerados,
                type: 'POST',
                success: function (data) {
                    $("#creditFund").text(TotalAmount.toString());
                    pointFlag = true;
                    points = $("#requiredPoints").val();
                    pointsUsed = $("#requiredPoints").val();
                    $("#points").hide();
                    $("#Step3").toggle();
                    $("#Step4").toggle();
                }, error: function (data) {
                    console.log(data);
                }
            });
        }
        else{
            alert("Favor de poner una cantidad menor o igual a la cantidad a pagar.");
        }
        
    }

    function ItsOver() {
        if(usedCredit){
            var cardNumber = $("#cardNumber").val();
            var mes = $("#mes").val();
            var ano = $("#ano").val();
            var cvv = $("#cvv").val();

            for (var item in seatsList) {
                var wea = {
                    "sala": TheatreRoom,
                    "hora": selectedSchedule,
                    "pelicula": selectedMovie,
                    "name": seatsList[item],
                    "tipo": ticketType,
                    "precio": parseInt(selectedTicket)
                }

                products.push(wea);
            }

            var venta = {
                "usedCredit": usedCredit,
                "pointFlag": pointFlag,
                "cash": 0,
                "credit": (TotalAmount - pointsUsed),
                "helper": true,
                "sala": TheatreRoom,
                "schedule": Judir + " " + selectedSchedule,
                "hora": selectedSchedule,
                "UsedSeats": seatsList,
                "cvv": cvv,
                "ano": ano,
                "mes": mes,
                "tarjeta_origen": cardNumber,
                "Codigo_Cliente": userMembershipId,
                "Puntos": pointsUsed,
                "Nombre_Cliente": cardHolder,
                "productos": products,
                "total": TotalAmount
            };
        }
        else{
            var cardNumber = 1234567890123456;
            var mes = 01;
            var ano = 21;
            var cvv = 333;

            for (var item in seatsList) {
                var wea = {
                    "idBoleto": 107,
                    "sala": TheatreRoom,
                    "hora": selectedSchedule,
                    "pelicula": selectedMovie,
                    "name": seatsList[item],
                    "tipo": selectedTicketType,
                    "precio": parseInt(selectedTicket)
                }
                products.push(wea);
            }

            var venta = {
                "helper": true,
                "sala": TheatreRoom,
                "schedule": Judir + " " + selectedSchedule,
                "UsedSeats": seatsList,
                "mes": mes,
                "ano": ano,
                "cvv": cvv,
                "tarjeta_origen": cardNumber,
                "total": TotalAmount,
                "productos": products
            };
        }

        $.ajax({
            url: "/api/Booth/PostTicketSale",
            type: 'POST',
            contentType: "application/json",
            data: JSON.stringify(venta),
            success: function (data) {
                alert("Compra realizada con exito");
                $("#finaldiv").hide();
                $("#Step5").show();

                $("#movie").text(movie);                    //Listo
                $("#runningTime").text(selectedSchedule);   //Listo
                $("#ticketType").text(ticketType);          //Listo
                debugger;
                //Si utilizó puntos
                if (pointFlag) {
                    $("#pointsTicket").text(pointsUsed.toString());                   
                    $("#credit").text((TotalAmount - pointsUsed).toString());   //Listo
                    $("#cash").text((TotalAmount - pointsUsed).toString());     //Listo 
                }
                else {
                    $("#pointsTicket").text("0");
                    $("#cash").text(TotalAmount.toString());
                    $("#credit").text(TotalAmount.toString());
                }
                //Pago con credito o efectivo
                if (usedCredit) {
                    $("#cash").text("0");
                }
                else {
                    $("#credit").text("0");
                }

                $("#total").text(TotalAmount.toString());   //Listo


                //var pago =
                //{
                //    Cash : 0,
                //    CreditCard : TotalAmount - pointsUsed,
                //    RewardPoints : pointsUsed
                //}

                //$.ajax({
                //    url: "/api/Payment",
                //    type: 'POST',
                //    contentType: "application/json",
                //    data: {'pago':pago},
                //    success: function (data) {
                //        alert("Pago exitoso");
                //    }, error: function (data) {
                //        console.log(data);
                //    }
                //});
            }, error: function (data) {
                console.log(data);
            }

        });
    }

    function textInput(field) {
    //var regExpr =  /^\d+$/;
    //if (!regExpr.test(field.value)) {
    //  //Case of error
    //    field.value = "";
    //    alert("Favor de llenar los datos");
    //}
}

</script>
